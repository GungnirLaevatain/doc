# 1 事务的特性
事务有以下四个特性：
1. 原子性：事务是最小的执行单元，事务内的操作要么全部成功，要么全部失败
2. 持久性：事务成功对于数据修改的结果是持久的，即使数据库故障也不应该导致结果的变更
3. 隔离性：并发访问时，事务和事务直接应该是互不影响的
4. 一致性：并发访问时，多个事务读取的同一个数据应该是一致的
# 2 并发事务带来的问题
## 2.1 脏读
当A事务对于一条记录进行修改，但是尚未提交时，B事务也读取了该条记录，此时B事务读取到的数据是未提交的脏数据，从而发生脏读
## 2.2 修改丢失
当A事务对于一条记录进行修改后，B事务同样对该条记录进行了修改，从而导致覆盖了A的修改，使A的修改丢失
## 2.3 不可重复读
当A事务读取一条记录后，B对该条记录进行了修改，此时A再次读取该条记录，发现和之前读取的不一致，从而导致不可重复读，
该问题主要侧重于记录的修改
## 2.4 幻读
当A事务查询了一批数据后，B在其中插入或.删除了部分数据，A再次查询时，发现和之前的不一致，此时便是幻读，
该问题主要侧重于记录的新增和移除
# 3 事务的隔离级别
## 3.1 读未提交（READ-UNCOMMITTED）
该隔离级别最低，允许事务读取到其他事务未提交的数据，故会发生脏读等问题
## 3.2 读已提交（READ-COMMITTED）
该隔离级别只允许事务读取到其他事务已提交的数据，能防止脏读，但是会发生不可重复读和幻读
## 3.3 可重复读（REPEATABLE-READ）
该隔离级别保证一个事务内对于一条记录多次读取的结果是一致的，能防止不可重复读，但是不能防止幻读
## 3.4 可串行化（SERIALIZABLE）
该隔离级别最高，所有事务逐个进行，所以能防止幻读
# 4 锁
## 4.1 表锁
当发生DDL操作时，对全表进行加锁
## 4.2 行锁
对于需要操作的记录进行加锁。当走主键索引时，直接给主键索引加锁，当走非主键索引是，先给非主键索引加锁，再给对应的主键索引加锁
## 4.3 间隙锁
为了在可重复读级别下解决幻读问题而引入的锁。用于锁住更新的记录的和前后记录之间的空间，防止新数据的插入导致幻读
# 5 MVCC
## 5.1 使用的额外字段
MySQL对于每条记录额外增加以下字段：
1. DB_TRX_ID：用于记录最后影响该记录的事务版本号（创建的事务版本号或者删除的事务版本号）
2. DB_ROLL_PTR：指向undo log的回滚记录的指针
3. DB_ROW_ID：若无指定的聚簇索引，则将由该字段生成聚餐索引
4. DELETE BIT：用于标志该行是否被删除（直到commit才正式生效）  
## 5.2 事务的可见性控制
设当前记录的事务版本号为stable_version,当前构建的事务快照内运行中事务中版本号最小的为min_version,
当前已经完成的事务里最大的版本号+1后为max_version  
当stable_version<min_version时，表示该记录已经被提交，对当前快照可见  
当stable_version>max_version时，表示该记录已被之后开启的事务所修改，对当前快照不可见，需要根据回滚指针从undo log内获取之前的记录版本号再次进行判断
当min_version时<=stable_version<=max_version时，首先遍历当前快照活跃事务的版本号并与stable_version进行对比，若
吻合，意味着被当前其他事务修改，需要根据回滚指针从undo log获取上一次的版本进行重新判断。若皆不吻合，意味已被其他事务提交，
故对当前快照可见